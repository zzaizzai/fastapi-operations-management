{% extends "layout.html" %}

{% block content %}

<style>
    
    h2 {
        color: #333;
        margin-bottom: 20px;
    }

    h3 {
        color: #555;
    }

    .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .product-details {
        padding: 20px;
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 5px;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
    }
/* 기본 스타일 */
.horizontal-timeline {
  position: relative;
}

.timeline-item {
  position: relative;
  padding: 10px;
}

.timeline-mark {
  content: " ";
  position: absolute;
  left: 0;
  top: 50%;
  margin-left: -4px;
  margin-top: -4px;
  width: 8px;
  height: 8px;
  background: #919191;
  border-radius: 50%;
}

/* 회색 선 스타일 설정 */
.timeline-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: -2px;
    height: 100%;
    width: 4px;
    background: #e2e2e2;
}

.timeline-date {
  font-weight: bold;
  margin-bottom: 5px;
}

.timeline-content {
  /* 이벤트 내용 스타일 설정 */
}


</style>




{% if history %}
<div class="container">




    <h2>History Detail</h2>
    <div class="product-details">
        <h3>ID: {{history.id}}</h3>
        <div>Name:{{history.product_name}}</div>
        <div>Quantity: {{history.quantity}}</div>
        <!-- <div>Created: {{history.datetime_created}}</div> -->
        <!-- <div>Due: {{history.date_due}}</div> -->
        <div>Sold: {{history.datetime_sold}}</div>
        <div>Location: {{history.location_current}}</div>
        <div>Process: {{history.process}}</div>
        <div>Lead_time: {{history.lead_time}}</div>
        <div>Lot: {{history.lot}}</div>
    </div>

    
    <div class="mx-5">
        <h3>Time Line</h3>
        <div class="horizontal-timeline">
            <div class="timeline-item">
                <div class="timeline-mark"></div>
                <div class="timeline-date">{{history.datetime_created}}</div>
                <div class="timeline-content">Created</div>
            </div>
            <div class="timeline-item">
                <div class="timeline-mark"></div>
                <div class="timeline-date" id="start-plan-calculated"></div>
                <div class="timeline-content">Calculated Start Plan</div>
            </div>
            <div class="timeline-item">
                <div class="timeline-mark"></div>
                <div class="timeline-date">{{history.date_due}}</div>
                <div class="timeline-content">Due</div>
            </div>
            <!-- Add more timeline items here -->
        </div>
    </div>


    <button class="mx-5 button button-red" id="calculateButton" onclick="handleCalculateButtonClick()">Calculate</button>
    <div id="result"></div> <!-- This is where the calculated data will be displayed -->
</div>


{% include 'spinner.html' %}

<script>



//     // 현재 시간을 얻어오는 함수
//     function getCurrentTime() {
//         return new Date();
//     }

//     // 타임라인에서 가장 가까운 시간 항목을 찾는 함수
//     function findNearestTimelineItem(currentTime) {
//         var timeline = $(".horizontal-timeline");
//         var timelineDates = timeline.find(".timeline-date");
//         var nearestItemIndex = -1;
//         var nearestItemTimeDiff = Infinity;

//         timelineDates.each(function(index, element) {
//             var date = new Date($(element).text());
//             var timeDiff = Math.abs(currentTime - date);

//             if (timeDiff < nearestItemTimeDiff) {
//                 nearestItemTimeDiff = timeDiff;
//                 nearestItemIndex = index;
//             }
//         });

//         return nearestItemIndex;
//     }

//     function formatDate(date) {
//     var year = date.getFullYear();
//     var month = (date.getMonth() + 1).toString().padStart(2, '0');
//     var day = date.getDate().toString().padStart(2, '0');
    
//     return year + '-' + month + '-' + day;
// }

//     // 타임라인에 현재 시간 항목 추가
//     function addCurrentTimeItem() {
//         var currentTime = getCurrentTime();
//         var nearestItemIndex = findNearestTimelineItem(currentTime);

//         if (nearestItemIndex >= 0) {
//             var timeline = $(".horizontal-timeline");
//             var timelineItems = timeline.find(".timeline-item");
//             var newTimelineItem = $("<div class='timeline-item current-time'></div>");
//             var newTimelineMark = $("<div class='timeline-mark'></div>");
//             var newTimelineDate = $("<div class='timeline-date'>" +  formatDate(currentTime) + "</div>");
//             var newTimelineContent = $("<div class='timeline-content'>Now</div>");

//             newTimelineItem.append(newTimelineMark);
//             newTimelineItem.append(newTimelineDate);
//             newTimelineItem.append(newTimelineContent);

//             timelineItems.eq(nearestItemIndex).after(newTimelineItem);
//         }
//     }

//     // 초기에 타임라인에 현재 시간 항목 추가

    function addTimeLine(data) {
            var timeline = $(".horizontal-timeline");
            var newTimelineItem = $("<div class='timeline-item'></div>");
            var newTimelineMark = $("<div class='timeline-mark'></div>");
            var newTimelineDate = $("<div class='timeline-date'>" +  data.date + "</div>");
            var newTimelineContent = $(`<div class='timeline-content'>${data.title}</div>`);

            newTimelineItem.append(newTimelineMark);
            newTimelineItem.append(newTimelineDate);
            newTimelineItem.append(newTimelineContent);
            timeline.append(newTimelineItem)
    }



    // Define a separate function to handle the button click
    function handleCalculateButtonClick() {
        // Disable the button while loading
        $("#calculateButton").prop("disabled", true);

        // Add the blur class to the container
        $("#overlay").show();

        // Show the spinner
        $(".spinner-box").show();

        // Make an AJAX request to the API
        $.ajax({
            url: "/products/api/get_time_line?history_id={{history.id}}",
            method: "GET",
            dataType: "json",
            success: function(data) {
                // Update the result div with the received data

                // Remove the blur class
                $("#overlay").hide();

                // Hide the spinner
                $(".spinner-box").hide();

                // Enable the button
                $("#calculateButton").prop("disabled", false);
                
                var timeline = $(".horizontal-timeline");
                timeline.children().remove()
                $("#start-plan-calculated").html(data);
                console.log(data)
                data.forEach(element => {
                    addTimeLine(element)
                    
                });
                // addCurrentTimeItem()
            },
            error: function() {
                alert("Error fetching data from the API.");

                // Remove the blur class
                $("#overlay").hide();

                // Hide the spinner
                $(".spinner").hide();

                // Enable the button
                $("#calculateButton").prop("disabled", false);
            }
        });
    }




</script>





{% endif %}
{% endblock %}